#!/bin/sh

WANIF=`uci -P /var/state -q get network.wan.ifname`
WANUP=`uci -P /var/state -q get network.wan.up`
WAN1IF=`uci -P /var/state -q get network.wan1.ifname`
WAN1UP=`uci -P /var/state -q get network.wan1.up`
WAN2IF=`uci -P /var/state -q get network.wan2.ifname`
WAN2UP=`uci -P /var/state -q get network.wan2.up`
if [ -z "$WANUP" ]; then WANUP=0; fi
if [ -z "$WAN1UP" ]; then WAN1UP=0; fi
if [ -z "$WAN2UP" ]; then WAN2UP=0; fi
logger -t chilli "Chilli hotplug due to $ACTION of $INTERFACE ($DEVICE). WAN=${WANIF},${WANUP} WAN1=${WAN1IF},${WAN1UP} WAN2=${WAN2IF},${WAN2UP}"

dorestart() {
    # Now restart
    /etc/init.d/chilli restart
}

if [ "$ACTION" == "ifup" ]; then
    echo "ifup for $INTERFACE ($DEVICE)"
    logger -t chilli "ifup for $INTERFACE ($DEVICE)"
    if printf "$INTERFACE" | grep -Eqe "^wan"; then
        PROCESSCOUNT=`ps -w | grep -v grep | grep -cw chilli`
        if [ "$PROCESSCOUNT" == "0" ]; then
            logger -t chilli "ifup for $INTERFACE ($DEVICE). No chilli deamon is running, so I will start it."
            dorestart
        else
            logger -t chilli "ifup for $INTERFACE ($DEVICE). Chilli deamon is already running, so I will NOT start it."
        fi

    elif [ "$INTERFACE" == "lan" ]; then
        ## Enable DHCP on LAN
        logger -t chilli "Starting $INTERFACE, and setting dhcp.lan.ignore='0'"
        uci set dhcp.lan.ignore='0'
        uci commit dhcp
        /etc/init.d/dnsmasq restart
    else
        logger -t chilli "Not starting chilli, since $INTERFACE is not wan"
    fi

elif [ "$ACTION" == "ifdown" ]; then
    echo "ifdown for $INTERFACE ($DEVICE)"
    if printf "$INTERFACE" | grep -Eqe "^wan"; then
        if [ "$WANUP" == "1" ] || [ "$WAN1UP" == "1" ] || [ "$WAN2UP" == "1" ]; then
            if [ "$WANUP" == "1" ]; then
                logger -t chilli "WANUP=$WANUP"
            elif [ "$WAN1UP" == "1" ]; then
                logger -t chilli "WAN1UP=$WAN1UP"
            elif [ "$WAN2UP" == "1" ]; then
                logger -t chilli "WAN2UP=$WAN2UP"
            fi
            dorestart

        else
            /etc/init.d/chilli stop
            logger -t chilli "Neither wan, wan1 or wan2 up. Stopping chilli."
        fi
    else
        logger -t chilli "$ACTION for $INTERFACE ($DEVICE). Chilli not changed."
    fi

else
    echo "$ACTION for $INTERFACE ($DEVICE)"
    logger -t chilli "Unknown: $ACTION for $INTERFACE ($DEVICE)"
fi
